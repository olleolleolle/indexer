apply plugin: 'java'
apply plugin: 'idea'
apply from: 'external-dependencies.gradle'
apply from: 'idea-config.gradle'

group 'indexer'

task wrapper(type: Wrapper) {
    gradleVersion = '2.6'
}

repositories {
    mavenCentral()
}

dependencies {
    compile postgresClient, jdbi, aws_cloudsearch, aws_cloudwatch, stringTemplate, jersey_client, logging_api, logging_impl
    testCompile junit, mockito, wiremock
}

test {
  testLogging {
    exceptionFormat = 'full'
  }
}

jar.baseName = "indexer"

jar {
    doFirst {
        from {
            configurations.compile.collect {
                it.isDirectory() ? it : zipTree(it)
            }
        } 
        manifest {
            attributes(
                    "Main-Class": "uk.gov.indexer.Application",
                    "Class-Path": configurations.runtime.findAll { !it.directory }.collect { it.name }.join(' ')
            )
        }
    }
    exclude 'META-INF/*.RSA', 'META-INF/*.SF','META-INF/*.DSA'
}

assemble{
    doLast{
        new File("deploy/indexer.jar").bytes = new File("build/libs/indexer.jar").bytes
        createDeployableBundle.execute()
    }
}

task createDeployableBundle(type:Zip)  {
    Map env  = System.getenv()
    baseName("indexer-${env.'TRAVIS_BRANCH'}-${env.'TRAVIS_BUILD_NUMBER'}-${env.'TRAVIS_COMMIT'}")
    from ('deploy/')
    include('*')
    include('scripts/*')
    destinationDir file('deployable_bundle') // directory that you want your archive to be placed in
}

